name: Track New Followers and Stars

on:
  schedule:
    - cron: '0 */6 * * *'  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  track-followers:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Track followers and create notifications
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          USERNAME="NickScherbakov"
          DATA_DIR=".github/data"
          FOLLOWERS_FILE="$DATA_DIR/followers.txt"
          
          mkdir -p "$DATA_DIR"
          touch "$FOLLOWERS_FILE"
          
          # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ followers
          gh api users/$USERNAME/followers --paginate --jq '.[].login' | sort > /tmp/current_followers.txt
          
          # –°—Ä–∞–≤–Ω–∏—Ç—å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º —Å–ø–∏—Å–∫–æ–º
          if [ -f "$FOLLOWERS_FILE" ]; then
            # –ù–∞–π—Ç–∏ –Ω–æ–≤—ã—Ö followers
            NEW_FOLLOWERS=$(comm -13 "$FOLLOWERS_FILE" /tmp/current_followers.txt)
            
            if [ -n "$NEW_FOLLOWERS" ]; then
              echo "New followers found!"
              
              # –°–æ–∑–¥–∞—Ç—å Issue –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ follower
              for follower in $NEW_FOLLOWERS; do
                # –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                USER_INFO=$(gh api users/$follower --jq '{name: .name, bio: .bio, repos: .public_repos, followers: .followers, location: .location, blog: .blog}')
                USER_NAME=$(echo "$USER_INFO" | jq -r '.name // "Not specified"')
                USER_BIO=$(echo "$USER_INFO" | jq -r '.bio // "No bio"')
                USER_REPOS=$(echo "$USER_INFO" | jq -r '.repos')
                USER_FOLLOWERS=$(echo "$USER_INFO" | jq -r '.followers')
                USER_LOCATION=$(echo "$USER_INFO" | jq -r '.location // "Not specified"')
                USER_BLOG=$(echo "$USER_INFO" | jq -r '.blog // "None"')
                
                ISSUE_BODY="## üëã –ù–æ–≤—ã–π –ø–æ–¥–ø–∏—Å—á–∏–∫: @$follower

### –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:
| | |
|---|---|
| üë§ **–ò–º—è** | $USER_NAME |
| üìç **–õ–æ–∫–∞—Ü–∏—è** | $USER_LOCATION |
| üìù **Bio** | $USER_BIO |
| üìÇ **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏** | $USER_REPOS |
| üë• **–ü–æ–¥–ø–∏—Å—á–∏–∫–∏** | $USER_FOLLOWERS |
| üîó **–°–∞–π—Ç** | $USER_BLOG |

### –ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏:
- üè† [–ü—Ä–æ—Ñ–∏–ª—å](https://github.com/$follower)
- üìö [–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏](https://github.com/$follower?tab=repositories)
- ‚≠ê [Starred —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏](https://github.com/$follower?tab=stars)

---
*–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –≤ –æ—Ç–≤–µ—Ç –∏ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –∑–≤—ë–∑–¥—ã –Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã!* ‚ú®"

                gh issue create \
                  --title "üåü –ù–æ–≤—ã–π –ø–æ–¥–ø–∏—Å—á–∏–∫: $follower" \
                  --body "$ISSUE_BODY" \
                  --label "new-follower,needs-attention"
                  
                echo "Created issue for new follower: $follower"
              done
            fi
          fi
          
          # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫
          cp /tmp/current_followers.txt "$FOLLOWERS_FILE"
          
          # –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase || true
          git add "$DATA_DIR"
          git diff --staged --quiet || git commit -m "üìä Update followers tracking data"
          git push || true

  track-stars:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Track stargazers and create notifications
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          USERNAME="NickScherbakov"
          DATA_DIR=".github/data"
          STARS_FILE="$DATA_DIR/stargazers.txt"
          
          mkdir -p "$DATA_DIR"
          touch "$STARS_FILE"
          
          # –ü–æ–ª—É—á–∏—Ç—å stargazers –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          gh api repos/$USERNAME/$USERNAME/stargazers --paginate --jq '.[].login' | sort > /tmp/current_stars.txt
          
          # –°—Ä–∞–≤–Ω–∏—Ç—å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º —Å–ø–∏—Å–∫–æ–º
          if [ -f "$STARS_FILE" ]; then
            NEW_STARGAZERS=$(comm -13 "$STARS_FILE" /tmp/current_stars.txt)
            
            if [ -n "$NEW_STARGAZERS" ]; then
              echo "New stargazers found!"
              
              for stargazer in $NEW_STARGAZERS; do
                USER_INFO=$(gh api users/$stargazer --jq '{name: .name, bio: .bio, repos: .public_repos, followers: .followers, location: .location}')
                USER_NAME=$(echo "$USER_INFO" | jq -r '.name // "Not specified"')
                USER_BIO=$(echo "$USER_INFO" | jq -r '.bio // "No bio"')
                USER_REPOS=$(echo "$USER_INFO" | jq -r '.repos')
                USER_LOCATION=$(echo "$USER_INFO" | jq -r '.location // "Not specified"')
                
                ISSUE_BODY="## ‚≠ê –ù–æ–≤–∞—è –∑–≤–µ–∑–¥–∞ –æ—Ç: @$stargazer

### –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:
| | |
|---|---|
| üë§ **–ò–º—è** | $USER_NAME |
| üìç **–õ–æ–∫–∞—Ü–∏—è** | $USER_LOCATION |
| üìù **Bio** | $USER_BIO |
| üìÇ **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏** | $USER_REPOS |

### –ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏:
- üè† [–ü—Ä–æ—Ñ–∏–ª—å](https://github.com/$stargazer)
- üìö [–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏](https://github.com/$stargazer?tab=repositories)
- ‚≠ê [–ß—Ç–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é](https://github.com/$stargazer?tab=stars)

---
*–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ü–µ–Ω–∏–ª –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å! –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ—Å—Ç–∞–≤–∏—Ç—å –∑–≤—ë–∑–¥—ã –Ω–∞ –µ–≥–æ –ø—Ä–æ–µ–∫—Ç—ã!* üåü"

                gh issue create \
                  --title "‚≠ê –ù–æ–≤–∞—è –∑–≤–µ–∑–¥–∞ –æ—Ç: $stargazer" \
                  --body "$ISSUE_BODY" \
                  --label "new-star,needs-attention"
                  
                echo "Created issue for new stargazer: $stargazer"
              done
            fi
          fi
          
          cp /tmp/current_stars.txt "$STARS_FILE"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase || true
          git add "$DATA_DIR"
          git diff --staged --quiet || git commit -m "üìä Update stargazers tracking data"
          git push || true
